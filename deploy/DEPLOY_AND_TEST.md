# 🚀 完整部署和测试指南

## ⚠️ 重要说明

**本次修复包含以下关键更改：**

### 后端修复（commit ddbf6a4）
1. ✅ `novel_service.py`：将`full_content`字段调整为最高优先级
2. ✅ `writer.py`：生成章节时优先提取`full_content`字段

### 前端修复（commit fb56441）
3. ✅ `VersionSelector.vue`：修复版本选择器的内容提取逻辑
4. ✅ `WDVersionDetailModal.vue`：修复版本详情弹窗的内容提取逻辑
5. ✅ `ChapterContent.vue`：修复章节内容显示的提取逻辑
6. ✅ `WDWorkspace.vue`：修复工作区的内容提取逻辑
7. ✅ `WritingDesk.vue`：修复主界面的内容提取逻辑

**所有组件现在都会优先提取`full_content`字段！**

---

## 📦 第一步：等待构建完成（约10-15分钟）

1. 访问 GitHub Actions 页面查看构建状态：
   ```
   https://github.com/samuncleorange/arboris-novel/actions
   ```

2. 等待最新的 workflow run **#18** 或更高编号完成（标记为 ✅）
   - 提交信息应包含："fix: 前端统一修复content提取逻辑"
   - 标签：v1.1.1

---

## 🔧 第二步：部署最新镜像

```bash
# 1. 进入部署目录
cd /Users/shu/Documents/fix_nocel/arboris-novel/deploy

# 2. 停止现有容器
docker-compose down

# 3. 删除旧镜像（确保拉取最新版本）
docker rmi ghcr.io/samuncleorange/arboris-novel:latest

# 4. 拉取最新镜像
docker-compose pull

# 5. 启动服务
docker-compose up -d

# 6. 查看日志（确认启动成功）
docker-compose logs -f arboris-app
# 按 Ctrl+C 退出日志查看
```

---

## 🧪 第三步：测试修复效果

### ⚠️ 关键：必须删除旧章节重新生成！

**为什么？** 旧章节是用旧代码生成的，数据库中存储的就是完整JSON。即使部署了新代码，旧数据不会自动更新。

### 测试步骤：

1. **登录系统**
   - 访问：`http://localhost:28788` 或你的服务器地址

2. **打开项目**
   - 进入任意小说项目的写作界面

3. **删除旧章节（重要！）**
   - 选中有问题的旧章节
   - 点击"删除章节"按钮
   - 确认删除

4. **生成新章节**
   - 点击"开始写作"按钮
   - 等待生成完成（可能需要1-2分钟）
   - **检查点1**：生成完成后，应该**自动跳转**到版本选择界面（不需要刷新）
   - **检查点2**：在版本选择界面中，预览内容应该是纯文本，不包含JSON结构

5. **选择版本并查看**
   - 选择任意一个版本
   - 点击"确认选择此版本"
   - **检查点3**：章节内容应该只显示纯文本，格式如下：
     ```
     约 4500 字
     导出TXT

     那天是星期六。蔡建国一大早就醒了......
     ```
   - ❌ **不应该**显示：
     ```json
     {
       "title":"人民公园的长椅",
       "summary":"...",
       "full_content":"那天是星期六......"
     }
     ```

6. **点击"查看详情"**
   - 在版本选择界面，点击任意版本的"查看详情"按钮
   - **检查点4**：弹窗中应该只显示纯文本内容

---

## ✅ 预期结果

如果修复成功，你应该看到：

1. ✅ 章节生成完成后自动显示版本选择器
2. ✅ 版本预览显示纯文本（前150字+ "..."）
3. ✅ 章节内容页面只显示小说正文
4. ✅ 字数统计正确（约4500字，而不是整个JSON的字符数）
5. ✅ 导出TXT文件只包含小说正文

---

## 🐛 如果问题仍然存在

### 问题1：章节内容仍显示完整JSON

**可能原因：**
- 你查看的是**旧章节**（用旧代码生成的）
- 解决方法：删除该章节，重新生成

**排查步骤：**
```bash
# 1. 确认镜像版本
docker images | grep arboris-novel
# 应该看到最新的镜像（几分钟前创建的）

# 2. 查看容器日志
docker-compose logs -f arboris-app
# 检查是否有报错

# 3. 检查容器内的代码版本
docker exec -it deploy-arboris-app-1 cat /app/backend/app/services/novel_service.py | head -20
# 检查第9行是否是：full_content  # 最高优先级：完整章节内容
```

### 问题2：生成完成后不自动跳转

这个问题可能需要进一步调试。暂时的解决方法：
- 生成完成后手动刷新页面
- 然后选择版本

我会继续调查这个问题的根本原因。

---

## 📞 反馈

测试完成后请告诉我：
1. 是否成功部署了最新镜像？
2. 删除旧章节并重新生成后，新章节内容是否正确显示？
3. 是否还有其他问题？

**记住：一定要删除旧章节重新生成测试！旧数据不会自动修复！** 🐱
